<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPTV 抓包解析工具 | 潍坊移动适配版</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,sans-serif;background:#f6f7f9;padding:15px;color:#222}
.container{max-width:700px;margin:0 auto;background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
h1{text-align:center;color:#0066cc;margin-bottom:20px;font-size:22px}
.input-group{margin-bottom:15px}
.input-group label{display:block;margin-bottom:6px;font-weight:500}
textarea,input[type="file"]{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
textarea{min-height:140px;resize:vertical}
.btn{background:#0066cc;color:#fff;border:none;padding:10px 16px;border-radius:6px;margin:5px;cursor:pointer;font-size:14px}
.btn:hover{background:#0052aa}
.btn-box{text-align:center;margin:10px 0}
.radio-group{display:flex;justify-content:center;gap:15px;margin:10px 0}
.output{background:#f1f3f5;border-radius:6px;padding:10px;margin-top:10px;max-height:180px;overflow-y:auto;white-space:pre-wrap;font-size:13px}
.alert{background:#ffebee;color:#b71c1c;padding:10px;border-radius:6px;text-align:center;margin-top:10px;display:none}
.loading{text-align:center;padding:10px;display:none}
</style>
</head>
<body>
<div class="container">
<h1><i class="fa fa-wifi"></i> IPTV 抓包数据解析工具（潍坊移动）</h1>

<div class="input-group">
<label>上传抓包文件</label>
<input type="file" id="file" accept=".txt,.jsp,.xml,.json">
</div>

<div class="btn-box">
<button class="btn" onclick="extract()"><i class="fa fa-magic"></i> 提取地址</button>
</div>

<div class="input-group">
<label>粘贴抓包数据</label>
<textarea id="text" placeholder="粘贴潍坊移动抓包日志到这里"></textarea>
</div>

<div class="btn-box">
<button class="btn" onclick="downMcast()"><i class="fa fa-download"></i> 下载组播</button>
<button class="btn" onclick="downUcast()"><i class="fa fa-download"></i> 下载单播</button>
</div>

<div class="radio-group">
<label><input type="radio" name="fmt" value="txt" checked> TXT</label>
<label><input type="radio" name="fmt" value="m3u"> M3U</label>
</div>

<div class="loading" id="load"><i class="fa fa-spinner fa-spin"></i> 处理中…</div>
<div class="alert" id="msg"></div>

<div style="margin-top:20px">
<div style="font-weight:50px;margin-bottom:5px"><i class="fa fa-broadcast-tower"></i> 组播地址</div>
<div class="output" id="mcast"></div>
</div>

<div style="margin-top:15px">
<div style="font-weight:50px;margin-bottom:5px"><i class="fa fa-satellite-dish"></i> 单播地址</div>
<div class="output" id="ucast"></div>
</div>

</div>

<script>
let mcast = '', ucast = '';

function $(id){return document.getElementById(id)}

function showMsg(s){$('msg').innerText=s;$('msg').style.display='block';setTimeout(()=>$('msg').style.display='none',2500)}
function load(show){$('load').style.display=show?'block':'none'}

function extract(){
  let t = $('text').value;
  if(!t){showMsg('请粘贴或上传数据');return}
  load(1);
  setTimeout(()=>{
    try {
      // 1. 提取所有 ChannelListCallback 包裹的内容
      const callbackRegex = /ChannelListCallback\(([\s\S]*?)\);/g;
      const matches = [];
      let match;
      while ((match = callbackRegex.exec(t)) !== null) {
        matches.push(match[1]);
      }
      if (matches.length === 0) {
        throw new Error('未找到 ChannelListCallback 数据');
      }

      // 2. 合并并解析 JSON
      const jsonStr = '[' + matches.join(',') + ']';
      const data = JSON.parse(jsonStr);

      // 3. 提取所有频道列表
      const channels = [];
      data.forEach(item => {
        if (item && Array.isArray(item.channelList)) {
          channels.push(...item.channelList);
        }
      });

      if (channels.length === 0) {
        throw new Error('未找到频道数据');
      }

      // 4. 处理频道
      const mcastSet = new Set();
      const ucastSet = new Set();
      channels.forEach(channel => {
        const name = channel.name || '未知频道';
        const playurl = channel.playurl || '';
        const timeshifturl = channel.timeshifturl || '';

        // 组播地址 (rtp://)
        if (playurl.startsWith('rtp://')) {
          const cleanUrl = playurl.split('?')[0]; // 去掉参数
          mcastSet.add(`${name},${cleanUrl}`);
        }

        // 单播地址 (rtsp://)
        if (timeshifturl.startsWith('rtsp://')) {
          let cleanUrl = timeshifturl;
          if (cleanUrl.includes('.smil')) {
            cleanUrl = cleanUrl.split('.smil')[0] + '.smil';
          }
          ucastSet.add(`${name},${cleanUrl}`);
        }
      });

      mcast = Array.from(mcastSet).join('\n');
      ucast = Array.from(ucastSet).join('\n');

      $('mcast').innerText = mcast || '无';
      $('ucast').innerText = ucast || '无';

      if (!mcast && !ucast) {
        showMsg('未识别到地址');
      }
    } catch (e) {
      console.error('解析失败:', e);
      showMsg('数据解析失败: ' + e.message);
      // 降级：用旧方法尝试直接匹配
      doMcast(t);
      doUcast(t);
    }
    load(0);
  }, 300);
}

function doMcast(s){
  let set = new Set();
  let r = /"name"\s*:\s*"([^"]+)"[^}]*"playurl"\s*:\s*"(rtp:\/\/[^"]+)"/g;
  let m;
  while((m=r.exec(s))!=null){
    let channelName = m[1].trim();
    let rtpUrl = m[2].trim();
    if(rtpUrl.includes('?')) rtpUrl = rtpUrl.split('?')[0];
    set.add(channelName + ',' + rtpUrl);
  }
  mcast = Array.from(set).join('\n');
  $('mcast').innerText = mcast || '无'
}

function doUcast(s){
  let set = new Set();
  let r = /"name"\s*:\s*"([^"]+)"[^}]*"timeshifturl"\s*:\s*"(rtsp:\/\/[^"]+)"/g;
  let m;
  while((m=r.exec(s))!=null){
    let channelName = m[1].trim();
    let rtspUrl = m[2].trim();
    if(rtspUrl.includes('.smil')) rtspUrl = rtspUrl.split('.smil')[0] + '.smil';
    set.add(channelName + ',' + rtspUrl);
  }
  ucast = Array.from(set).join('\n');
  $('ucast').innerText = ucast || '无'
}

function save(content, type){
  if(!content){showMsg('请先提取'+type);return}
  let fmt = document.querySelector('input[name="fmt"]:checked').value;
  let name = `潍坊移动IPTV_${type}.${fmt}`;
  let c;
  if(fmt==='txt'){
    c=content
  }else{
    c='#EXTM3U x-tvg-url="https://epg.v1.mk/fy.xml"\n';
    content.split('\n').forEach(line=>{
      let [n,u]=line.split(',');
      if(n&&u) c+=`#EXTINF:-1 tvg-name="${n}" group-title="${type}",${n}\n${u}\n`
    })
  }
  let blob = new Blob([c],{type:'text/plain'});
  let a = document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=name;
  a.click();
}

function downMcast(){save(mcast,'组播')}
function downUcast(){save(ucast,'单播')}

$('file').onchange = function(){
  let f = this.files[0];
  if(!f)return;
  let rd=new FileReader();
  rd.onload=e=>{$('text').value=e.target.result;extract()}
  rd.readAsText(f)
}
</script>
</body>
</html>
