function save(content, type){
  if(!content){showMsg('请先提取'+type);return}
  let fmt = document.querySelector('input[name="fmt"]:checked').value;
  let name = `潍坊移动IPTV_${type}.${fmt}`;
  let c;

  if(fmt==='txt'){
    c = content;
  } else {
    // M3U 格式：按分类分组输出
    c = '#EXTM3U x-tvg-url="https://epg.v1.mk/fy.xml"\n';

    // 先把内容按行拆分，再按分类重新组织
    const lines = content.split('\n').filter(line => line.trim() !== '');
    const groups = {
      '央视': [],
      '本地/山东': [],
      '其他卫视': [],
      '数字': [],
      '少儿': [],
      '其他': []
    };

    lines.forEach(line => {
      const [name, url] = line.split(',');
      if (!name || !url) return;

      let group = '其他';
      if (/^CCTV/i.test(name)) group = '央视';
      else if (/山东|潍坊|诸城/i.test(name)) group = '本地/山东';
      else if (/卫视/i.test(name)) group = '其他卫视';
      else if (/数字|CHC|动作电影|家庭影院/i.test(name)) group = '数字';
      else if (/少儿|动画|儿童|KAKU/i.test(name)) group = '少儿';

      groups[group].push({ name, url });
    });

    // 按顺序输出各组
    const groupOrder = ['央视', '本地/山东', '其他卫视', '数字', '少儿', '其他'];
    groupOrder.forEach(groupName => {
      const items = groups[groupName];
      if (items.length > 0) {
        c += `\n#EXTGRP:${groupName}\n`;
        items.forEach(item => {
          c += `#EXTINF:-1 tvg-name="${item.name}" group-title="${groupName}",${item.name}\n${item.url}\n`;
        });
      }
    });
  }

  let blob = new Blob([c], {type: 'text/plain'});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}
