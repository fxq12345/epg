name: Gitee Auto Update EPG
on:
  schedule:
    - cron: '0 0,12 * * *'  # æ¯å¤©0ç‚¹ã€12ç‚¹è‡ªåŠ¨æ›´æ–°ï¼ˆUTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´8ç‚¹ã€20ç‚¹ï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆä¿ç•™ï¼‰
  push:
    branches: [ master ]  # è§¦å‘åˆ†æ”¯ï¼ˆæ ¹æ®å®é™…ä»“åº“åˆ†æ”¯åè°ƒæ•´ï¼Œå¦‚mainéœ€ä¿®æ”¹ï¼‰

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write  # å…è®¸æäº¤æ–‡ä»¶ï¼ˆå¿…é¡»ï¼‰

    steps:
      - name: é…ç½®Gitç½‘ç»œç¨³å®šæ€§
        run: |
          git config --global http.retry 5
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 60

      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: master  # ä¸è§¦å‘åˆ†æ”¯ä¸€è‡´
          fetch-depth: 1

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'  # é€‚é…è„šæœ¬ä¾èµ–
          cache: 'pip'  # ç¼“å­˜ä¾èµ–ï¼ŒåŠ å¿«è¿è¡Œé€Ÿåº¦

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4  # æ˜ç¡®å®‰è£…æ‰€éœ€ä¾èµ–ï¼ˆé¿å…requirements.txtç¼ºå¤±é—®é¢˜ï¼‰

      # è¿è¡Œæ½åŠEPGçˆ¬è™«ï¼ˆç”Ÿæˆoutput/weifang.xmlï¼‰
      - name: è¿è¡Œæ½åŠEPGçˆ¬è™«
        run: python weifang_epg_spider.py
        continue-on-error: false  # çˆ¬è™«å¤±è´¥åˆ™ç»ˆæ­¢æµç¨‹ï¼Œé¿å…ç”Ÿæˆæ— æ•ˆEPG

      # è¿è¡Œåˆå¹¶è„šæœ¬ï¼ˆç”Ÿæˆoutput/final_epg_complete.xmlï¼‰
      - name: è¿è¡ŒEPGåˆå¹¶è„šæœ¬
        run: python merge.py
        continue-on-error: false

      # å…³é”®ä¿®æ­£1ï¼šå°†åˆå¹¶åçš„æ–‡ä»¶é‡å‘½åä¸ºepg.xmlï¼ˆé€‚é…åŸæœ‰éªŒè¯é€»è¾‘ï¼‰
      - name: é‡å‘½åæœ€ç»ˆEPGæ–‡ä»¶
        run: |
          cd output
          mv final_epg_complete.xml epg.xml  # ä¸éªŒè¯æ­¥éª¤çš„æ–‡ä»¶åç§°ä¸€è‡´
          gzip -k epg.xml  # ç”Ÿæˆå‹ç¼©ç‰ˆepg.gzï¼ˆä¿ç•™åŸæ–‡ä»¶ï¼‰

      # éªŒè¯æ–‡ä»¶æœ‰æ•ˆæ€§ï¼ˆä¿®æ­£åè·¯å¾„ä¸€è‡´ï¼‰
      - name: éªŒè¯EPGæ–‡ä»¶
        run: |
          if [ ! -f "output/epg.xml" ] || [ $(stat -c%s "output/epg.xml") -lt 1000 ]; then
            echo "âŒ epg.xmlæ–‡ä»¶æ— æ•ˆæˆ–è¿‡å°"
            exit 1
          fi
          if [ ! -f "output/epg.gz" ] || [ $(stat -c%s "output/epg.gz") -lt 500 ]; then
            echo "âŒ epg.gzæ–‡ä»¶æ— æ•ˆæˆ–è¿‡å°"
            exit 1
          fi
          echo "âœ… EPGæ–‡ä»¶éªŒè¯é€šè¿‡"

      # æäº¤æ›´æ–°åˆ°ä»“åº“
      - name: æäº¤EPGæ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add output/*  # æäº¤outputç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼ˆweifang.xmlã€epg.xmlã€epg.gzï¼‰
          git commit -m "Auto update EPG: $(date +'%Y-%m-%d %H:%M:%S')" || echo "ğŸ“Œ æ— æ–°å†…å®¹éœ€è¦æ›´æ–°"
          git push origin master --force-with-lease  # æ›´å®‰å…¨çš„å¼ºåˆ¶æ¨é€ï¼ˆé¿å…è¦†ç›–ä»–äººä¿®æ”¹ï¼‰
