# .github/workflows/auto-update-epg.yml
name: ğŸš€ Auto Update EPG

on:
  # è®¡åˆ’ä»»åŠ¡ï¼šæ¯å¤©UTCæ—¶é—´0ç‚¹å’Œ12ç‚¹ï¼ˆå³åŒ—äº¬æ—¶é—´8ç‚¹å’Œ20ç‚¹ï¼‰è¿è¡Œ
  schedule:
    - cron: '0 0,12 * * *'
  # å…è®¸åœ¨GitHubç½‘é¡µæ‰‹åŠ¨è§¦å‘å·¥ä½œæµ [6,7,8](@ref)
  workflow_dispatch:
    # å¯é€‰ï¼šä¸ºæ‰‹åŠ¨è§¦å‘æ·»åŠ è¾“å…¥å‚æ•°ï¼Œä¾‹å¦‚é€‰æ‹©åˆ†æ”¯
    inputs:
      branch:
        description: 'è¦æ„å»ºçš„åˆ†æ”¯'
        required: true
        default: 'master'
        type: choice
        options:
        - master
        - develop
  # å½“ä»£ç æ¨é€åˆ°masteråˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ master ]

jobs:
  build-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # èµ‹äºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹çš„æƒé™ [7,8](@ref)
    permissions:
      contents: write

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ï¼ˆæ ¹æ®è§¦å‘æ–¹å¼åŠ¨æ€é€‰æ‹©åˆ†æ”¯ï¼‰
      - name: ğŸ›’ Checkout Code
        uses: actions/checkout@v4
        with:
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”æœ‰è¾“å…¥å‚æ•°ï¼Œåˆ™ä½¿ç”¨è¾“å…¥çš„åˆ†æ”¯ï¼Œå¦åˆ™ä½¿ç”¨master
          ref: ${{ github.event.inputs.branch || 'master' }}
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²è®°å½•ï¼Œæ–¹ä¾¿gitæ“ä½œ

      # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # ç¼“å­˜pipä¾èµ–ï¼ŒåŠ é€Ÿåç»­è¿è¡Œ

      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # å¦‚æœé¡¹ç›®æœ‰requirements.txtåˆ™å®‰è£…ï¼Œå¦åˆ™ç›´æ¥å®‰è£…æ ¸å¿ƒåŒ…
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install requests lxml
          fi

      # æ­¥éª¤4ï¼šè¿è¡ŒEPGç”Ÿæˆè„šæœ¬
      - name: âš™ï¸ Run EPG Generator
        run: python merge.py

      # æ­¥éª¤5ï¼šéªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
      - name: âœ… Validate Generated Files
        run: |
          echo "Checking generated EPG files..."
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¤§å°åˆç†
          if [ ! -f "output/epg.xml" ] || [ $(stat -c%s "output/epg.xml") -lt 100 ]; then
            echo "âŒ EPG XML file is invalid or too small"
            exit 1
          fi
          if [ ! -f "output/epg.gz" ] || [ $(stat -c%s "output/epg.gz") -lt 50 ]; then
            echo "âŒ EPG GZ file is invalid or too small"
            exit 1
          fi
          echo "âœ… All files validated successfully"
          echo "File sizes:"
          ls -la output/

      # æ­¥éª¤6ï¼šé…ç½®Gitå¹¶æäº¤æ›´æ–°ï¼ˆä»…åœ¨masteråˆ†æ”¯ä¸”éPRæ—¶æ‰§è¡Œï¼‰
      - name: ğŸ’¾ Commit Updates
        # æ¡ä»¶ï¼šåœ¨masteråˆ†æ”¯ä¸Šè¿è¡Œï¼Œä¸”ä¸æ˜¯PRäº‹ä»¶ [8](@ref)
        if: github.ref == 'refs/heads/master' && github.event_name != 'pull_request'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æ›´æ”¹
          git status
          git add output/
          
          # ä»…åœ¨å­˜åœ¨æ›´æ”¹æ—¶æäº¤
          if git diff-index --quiet HEAD --; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-update EPG data: $(date +'%Y-%m-%d %H:%M:%S')"
            # ä½¿ç”¨--force-with-leaseæ¯”--forceæ›´å®‰å…¨ [8](@ref)
            git push --force-with-lease origin master
            echo "âœ… Changes committed and pushed"
          fi
