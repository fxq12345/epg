name: EPG Merge

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点运行
  workflow_dispatch:      # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml selenium
        
    - name: Create output directory
      run: |
        mkdir -p output
        echo "当前目录结构:"
        ls -la
        echo "output目录:"
        ls -la output/ || echo "output目录不存在"
        
    - name: Create test config file
      run: |
        # 创建一个简单的测试配置文件
        cat > config.txt << 'EOF'
        # 测试用的EPG源
        https://epg.112114.xyz/pp.xml.gz
        EOF
        echo "config.txt内容:"
        cat config.txt
        
    - name: Run EPG merge script
      run: |
        echo "开始运行合并脚本..."
        python merge.py
        echo "脚本运行完成"
        
    - name: Check output files
      run: |
        echo "检查输出文件:"
        ls -la output/
        if [ -f "output/epg.gz" ]; then
          echo "✅ epg.gz文件存在"
          echo "文件大小: $(stat -c%s output/epg.gz) 字节"
          echo "前100个字符:"
          gzip -dc output/epg.gz | head -c 100
          echo ""
        else
          echo "❌ epg.gz文件不存在"
        fi
        
    - name: Commit and push
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        git add -A
        if git diff --cached --quiet; then
          echo "没有文件变更，无需提交"
        else
          git commit -m "Update EPG $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
