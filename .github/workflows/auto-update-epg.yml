name: EPGè‡ªåŠ¨æ›´æ–° (æ½åŠå®¹é”™ç‰ˆ)

on:
  # æ¯å¤©è§¦å‘ä¸€æ¬¡ï¼ˆUTCæ—¶é—´17:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´æ¬¡æ—¥01:00ï¼‰
  schedule:
    - cron: '0 17 * * *'
  # å…è®¸æ‰‹åŠ¨åœ¨ç½‘é¡µä¸Šç‚¹å‡»è¿è¡Œ
  workflow_dispatch:

jobs:
  build-and-sync:
    runs-on: ubuntu-latest
    # å…³é”®è®¾ç½®ï¼šå³ä½¿å†…éƒ¨æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿæ ‡è®°ä¸ºæˆåŠŸï¼ˆå¯é€‰ï¼Œæ›´æ¿€è¿›çš„å®¹é”™ï¼‰
    # continue-on-error: true 

    steps:
      # =================================================================
      # 1. æ‹‰å–ä»£ç å¹¶å¼ºåˆ¶é‡ç½® (è§£å†³ä½ æˆªå›¾ä¸­çš„å†²çªæŠ¥é”™)
      # =================================================================
      - name: ğŸ“‚ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ› ï¸ å¼ºåˆ¶é‡ç½®æœ¬åœ°æ–‡ä»¶ (è§£å†³å†²çª)
        run: |
          # å¼ºåˆ¶ç”¨è¿œç¨‹ä»“åº“çš„å†…å®¹è¦†ç›–æœ¬åœ°ï¼Œä¸¢å¼ƒæ‰€æœ‰æœ¬åœ°ä¿®æ”¹
          git fetch origin master
          git reset --hard origin/master
          git clean -fd
        # å³ä½¿è¿™ä¸€æ­¥å‡ºé”™ï¼ˆæ¯”å¦‚æƒé™é—®é¢˜ï¼‰ï¼Œä¹Ÿç»§ç»­ï¼Œé˜²æ­¢å¡æ­»
        continue-on-error: true 

      # =================================================================
      # 2. å‡†å¤‡ Python ç¯å¢ƒ
      # =================================================================
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install requests lxml beautifulsoup4

      # =================================================================
      # 3. è¿è¡Œæ½åŠçˆ¬è™« (æ ¸å¿ƒå®¹é”™ç‚¹)
      # =================================================================
      - name: ğŸ•·ï¸ è¿è¡Œæ½åŠçˆ¬è™« (å¤±è´¥ä¸å½±å“æµç¨‹)
        run: |
          # ç¡®ä¿ output ç›®å½•å­˜åœ¨
          mkdir -p output
          # è¿è¡Œè„šæœ¬
          python weifang_epg_spider.py
        # å…³é”®ï¼šå³ä½¿ Python è„šæœ¬æŠ¥é”™ï¼Œä¹Ÿç»§ç»­ä¸‹ä¸€æ­¥
        continue-on-error: true 

      # =================================================================
      # 4. è¿è¡Œä¸»åˆå¹¶è„šæœ¬
      # =================================================================
      - name: âš™ï¸ è¿è¡Œä¸»åˆå¹¶è„šæœ¬ (merge.py)
        run: |
          python merge.py

      # =================================================================
      # 5. æäº¤å¹¶æ¨é€åˆ° GitHub
      # =================================================================
      - name: ğŸ“¤ æäº¤æ›´æ–°åˆ° GitHub
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 1. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if git diff --quiet; then
            echo "â„¹ï¸ æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          # 2. æ·»åŠ æ–‡ä»¶å¹¶æäº¤
          git add .
          git commit -m "Auto: Update EPG Data $(date '+%Y-%m-%d %H:%M:%S')"
          
          # 3. æ¨é€åˆ° GitHub
          git push origin master
        # å…³é”®ï¼šå³ä½¿æäº¤å¤±è´¥ï¼ˆå¦‚ç½‘ç»œé—®é¢˜ï¼‰ï¼Œä¹Ÿä¸è®©æ•´ä¸ªæµç¨‹æŒ‚æ‰
        continue-on-error: true 

      # =================================================================
      # 6. (å¯é€‰) åŒæ­¥åˆ° Gitee
      # =================================================================
      # - name: ğŸ”„ åŒæ­¥åˆ° Gitee
      #   run: |
      #     # è¿™é‡Œå¡«å†™ä½ çš„ Gitee åŒæ­¥ä»£ç 
      #     echo "åŒæ­¥åˆ° Gitee..."
