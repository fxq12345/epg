name: 酷9设备EPG自动更新（山东频道优先）

# 触发条件：定时 + 手动
trigger:
  push: 'none'
  pr: 'none'
  tag: 'none'
  # 定时触发（每天 00:00 UTC，对应北京时间 08:00）
  schedule:
    - cron: '0 0 * * *'

# 流水线步骤
steps:
  - name: 检出代码
    uses: actions/checkout@v4
    with:
      fetch-depth: 0
      token: ${GITEE_TOKEN}

  - name: 设置Python环境
    uses: actions/setup-python@v5
    with:
      python-version: '3.10'

  - name: 安装依赖
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt || pip install pipenv && pipenv install --deploy

  - name: 运行EPG更新脚本（酷9适配 + 山东频道优先）
    run: |
      # 执行主更新脚本，并传入酷9适配和山东频道优先的参数
      python auto_update_epg.py \
        --device cool9 \
        --priority-channel "山东卫视,山东齐鲁,山东综艺,山东生活,山东农科,潍坊综合,潍坊公共" \
        --output-format xmltv \
        --output-path output/epg.xml

  - name: 生成酷9专用索引文件
    run: |
      cat > output/cool9_epg_index.txt << EOF
      # 酷9设备EPG索引文件
      # 优先频道：山东卫视、山东齐鲁、山东综艺、山东生活、山东农科、潍坊综合、潍坊公共
      # 自动更新时间: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
      epg_url=https://gitee.com/fxq12345/epg/raw/master/output/epg.xml
      EOF

  - name: 提交并推送更新
    run: |
      git config --local user.email "gitee-actions[bot]@noreply.gitee.com"
      git config --local user.name "gitee-actions[bot]"
      git add output/*.xml output/cool9_epg_index.txt || echo "No files to add"
      git commit -m "Auto-update EPG for Cool9 (Shandong priority) $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
      git push origin master
