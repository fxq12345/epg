name: 'Auto Update EPG'

on:
  schedule:
    - cron: '0 5,17 * * *'
  workflow_dispatch:
    branches:
      - master

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          pip install pipenv
          pipenv install --deploy
      
      - name: Generate EPG
        run: |
          echo "å¼€å§‹ç”ŸæˆEPG..."
          pipenv run epg
          echo "ç”Ÿæˆå®Œæˆ"
          
          # æ£€æŸ¥ç»“æœ
          if [[ -f "output/epg.xml" ]]; then
            echo "EPGæ–‡ä»¶å·²ç”Ÿæˆ"
            echo "å¤§å°: $(du -h output/epg.xml)"
            echo "è¡Œæ•°: $(wc -l < output/epg.xml)"
            
            # åˆ›å»ºå‹ç¼©æ–‡ä»¶
            gzip -c output/epg.xml > output/epg.gz
          else
            echo "é”™è¯¯ï¼šæœªç”Ÿæˆepg.xml"
            exit 1
          fi
      
      - name: Check EPG content
        run: |
          echo "=== æ£€æŸ¥EPGå†…å®¹ ==="
          if [[ -f "output/epg.xml" ]]; then
            # åŸºæœ¬ç»Ÿè®¡
            channels=$(grep -c '<channel ' output/epg.xml)
            programmes=$(grep -c '<programme ' output/epg.xml)
            echo "é¢‘é“: $channels"
            echo "èŠ‚ç›®: $programmes"
            
            # æ£€æŸ¥èŠ‚ç›®æ—¥æœŸ
            echo "=== èŠ‚ç›®æ—¥æœŸ ==="
            grep -o 'start="[0-9]\{8\}' output/epg.xml | sort | uniq -c | head -5
            
            # æ£€æŸ¥XMLæ ¼å¼
            echo "=== XMLæ ¼å¼ ==="
            head -3 output/epg.xml
          fi
      
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ–‡ä»¶
          git add output/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
          else
            # è·å–ç®€å•çš„ç»Ÿè®¡
            if [[ -f "output/epg.xml" ]]; then
              channels=$(grep -c '<channel ' output/epg.xml)
              programmes=$(grep -c '<programme ' output/epg.xml)
              git commit -m "ğŸ“º EPGæ›´æ–° ($(date +%m-%d) ${channels}é¢‘é“/${programmes}èŠ‚ç›®)"
            else
              git commit -m "ğŸ“º EPGæ›´æ–° $(date +'%Y-%m-%d %H:%M:%S')"
            fi
            
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          fi
