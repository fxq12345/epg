name: 'Auto Update EPG'

on:
  schedule:
    - cron: '0 5,17 * * *'
  workflow_dispatch:
    branches:
      - master

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install dependencies
        run: |
          pip install pipenv
          pipenv install --deploy
      
      - name: Generate EPG with timestamp
        run: |
          echo "ç”Ÿæˆå¼€å§‹æ—¶é—´: $(date)"
          echo "å½“å‰æ—¶åŒº: $(date +%Z)"
          echo "UTCæ—¶é—´: $(date -u)"
          
          # è¿è¡ŒEPGç”Ÿæˆ
          pipenv run epg
          
          echo "ç”Ÿæˆå®Œæˆæ—¶é—´: $(date)"
      
      - name: Fix and validate EPG
        run: |
          echo "=== ä¿®å¤å’ŒéªŒè¯EPG ==="
          
          if [[ ! -f "output/epg.xml" ]]; then
            echo "é”™è¯¯ï¼šæœªç”ŸæˆEPGæ–‡ä»¶"
            exit 1
          fi
          
          # 1. ä¿®å¤XMLæ ¼å¼
          echo "1. ä¿®å¤XMLæ ¼å¼..."
          # ç¡®ä¿æœ‰æ­£ç¡®çš„XMLå£°æ˜
          if ! head -1 output/epg.xml | grep -q '^<?xml'; then
            sed -i '1i<?xml version="1.0" encoding="UTF-8"?>' output/epg.xml
          fi
          
          # 2. åˆ†ææ—¶é—´æ•°æ®
          echo "2. åˆ†ææ—¶é—´æ•°æ®..."
          python3 << 'EOF'
import datetime
import re

with open('output/epg.xml', 'r', encoding='utf-8') as f:
    content = f.read()

# ç»Ÿè®¡ä¿¡æ¯
channels = len(re.findall(r'<channel\s', content))
programmes = len(re.findall(r'<programme\s', content))
print(f"é¢‘é“æ•°: {channels}")
print(f"èŠ‚ç›®æ•°: {programmes}")

# æå–æ—¥æœŸ
dates = re.findall(r'start="(\d{4})(\d{2})(\d{2})\d{6}', content)
if dates:
    unique_dates = set([f"{y}{m}{d}" for y, m, d in dates])
    print(f"æ¶‰åŠæ—¥æœŸæ•°: {len(unique_dates)}")
    
    # è½¬æ¢ä¸ºdatetimeå¯¹è±¡å¹¶æ’åº
    date_objs = [datetime.datetime(int(y), int(m), int(d)) for y, m, d in dates]
    earliest = min(date_objs)
    latest = max(date_objs)
    today = datetime.datetime.now()
    
    print(f"æœ€æ—©èŠ‚ç›®: {earliest.strftime('%Y-%m-%d')}")
    print(f"æœ€æ™šèŠ‚ç›®: {latest.strftime('%Y-%m-%d')}")
    print(f"ä»Šå¤©æ—¥æœŸ: {today.strftime('%Y-%m-%d')}")
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æœªæ¥èŠ‚ç›®
    future_progs = [d for d in date_objs if d >= today]
    print(f"æœªæ¥èŠ‚ç›®æ•°: {len(future_progs)}")
    
    if len(future_progs) == 0:
        print("âš ï¸ è­¦å‘Šï¼šæ²¡æœ‰æœªæ¥æ—¥æœŸçš„èŠ‚ç›®ï¼")
        print("ç”µè§†ä¸Šå°†çœ‹ä¸åˆ°èŠ‚ç›®é¢„å‘Šã€‚")
EOF
          
          # 3. å¦‚æœæœ‰é—®é¢˜ï¼Œå°è¯•ä¿®å¤æ—¶é—´
          echo "3. æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤æ—¶é—´..."
          python3 << 'EOF'
import re
from datetime import datetime, timedelta

with open('output/epg.xml', 'r', encoding='utf-8') as f:
    content = f.read()

# æ£€æŸ¥æ˜¯å¦æœ‰æ˜æ˜¾çš„æ—¶é—´é”™è¯¯ï¼ˆæ¯”å¦‚2025å¹´çš„æ•°æ®ï¼‰
old_pattern = r'start="2025\d{10}'
old_dates = re.findall(old_pattern, content)
if old_dates:
    print(f"å‘ç° {len(old_dates)} ä¸ª2025å¹´çš„è¿‡æ—¶èŠ‚ç›®")
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ—¶é—´ä¿®å¤é€»è¾‘
    # ä¾‹å¦‚ï¼šcontent = re.sub(r'start="2025', 'start="2026', content)
EOF
          
          # 4. åˆ›å»ºå‹ç¼©æ–‡ä»¶
          echo "4. åˆ›å»ºå‹ç¼©æ–‡ä»¶..."
          gzip -c -9 output/epg.xml > output/epg.gz
      
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add output/
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
            # ä¸ºäº†æµ‹è¯•ï¼Œè¿˜æ˜¯æäº¤ä¸€ä¸ªç©ºè®°å½•
            git commit --allow-empty -m "ğŸ“… EPGæµ‹è¯• - $(date +'%Y-%m-%d %H:%M:%S')"
          else
            # è·å–ç»Ÿè®¡ä¿¡æ¯
            channels=$(grep -c '<channel ' output/epg.xml)
            programmes=$(grep -c '<programme ' output/epg.xml)
            latest_date=$(grep -o 'start="[0-9]\{8\}' output/epg.xml | sort | tail -1)
            
            git commit -m "ğŸ“º EPGæ›´æ–° - é¢‘é“:${channels} èŠ‚ç›®:${programmes} æœ€æ–°:${latest_date}"
          fi
          
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
